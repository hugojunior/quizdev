<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser-arcade-physics.js"></script>
    <title>QuizDev</title>
    <style>
        body {
            margin: 0;
            background-color: #363a3c;
            color: #ffffff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            padding: 0;
        }

        a {
            color: yellow;
        }
        #container {
            margin: 0 auto;
            display: block;
            width: 800px;
            padding: 20px 0;
        }
        #qTags {
            background-color: #999;
            color: #000;
            padding: 2px 5px;
            border-radius: 3px;
            border: none;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <script>
        var Login = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Login ()
            {
                Phaser.Scene.call(this, { key: 'login'});
            },
        
            preload: function ()
            {
                this.load.html('formName', 'html/form-name.html');
                this.load.image('logo', 'images/logo2.png');
                this.load.image('bgLogin', 'images/bg-login2.jpg');
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bgLogin');
                this.add.image(400, 130, 'logo');
                
                var element = this.add.dom(400, 300).setInteractive().createFromCache('formName');

                element.addListener('click');
                element.on('click', function(event) {
                    if (event.target.name === 'showInfo')
                    {
                        var inputText = this.getChildByName('name');
            
                        if (inputText.value !== '')
                        {
                            this.removeListener('click');
                            this.setVisible(false);
                            var name = inputText.value;
                            this.scene.scene.start('info', { name: name.substring(0, 15) });    
                        }
                    }
                });
            }
        });
        
        var Info = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Info ()
            {
                Phaser.Scene.call(this, { key: 'info'});
            },
        
            init: function (data)
            {
                this.name = data.name;
            },

            preload: function ()
            {
                this.load.image('bgInfo', 'images/bg-info.jpg');
                this.load.html('infoText', 'html/info.html');
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bgInfo');
                this.add.text(20, 20, 'Bem-vindo,', { fontFamily: "'Courier New', Courier, monospace", fontSize: 20, color: "#333333", fontWeight: 'bold' });
                this.add.text(20, 40, this.name + '!', { fontFamily: "'Courier New', Courier, monospace", fontSize: 30, color: "#333333" });

                var element = this.add.dom(400, 250).setInteractive().createFromCache('infoText');
                element.addListener('click');
                element.on('click', function(event) {
                    if (event.target.name === 'startGame')
                    {                  
                        this.scene.scene.start('game', { name: this.scene.name.substring(0, 15) });
                    }
                });
            }
        
        });

        var Game = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Game ()
            {
                Phaser.Scene.call(this, { key: 'game'});
            },
        
            init: function (data)
            {
                this.name = data.name;
                this.initialCountdownTime = 180; //segundos
                this.lifes = 3;
                this.positionStart = 0;
                this.questionsCorrects = 0;
                this.questionsIds = [];
                this.questionsJson = {};
                this.currentQuestion = null;
                this.gameEnd = false;
            },

            preload: function ()
            {   
                this.input.keyboard.enabled = true;
                this.load.html(`gameOver`, `html/game-over.html`); 
                this.load.html(`success`, `html/success.html`);            
                this.load.image('logoProg', 'images/prog2.png');
                this.load.image('lifes3', 'images/lifes3.png');
                this.load.image('lifes2', 'images/lifes2.png');
                this.load.image('lifes1', 'images/lifes1.png');
                this.load.image('lifes0', 'images/lifes0.png');
                this.load.image('red', 'images/red.png');
                this.load.image('green', 'images/green.png');
                this.load.json('questionsJson', 'questions.json');
                this.loadQuestionsHTML();

                if(this.isDay()) {
                    this.load.image('bg', 'images/bg-dia-800.jpg');
                } else {
                    this.load.image('bg', 'images/bg-noite-800.jpg');
                }
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bg');
                              
                this.greenParticle = this.add.particles('green');
                this.redParticle = this.add.particles('red');
                this.prog = this.add.image(34, 380, 'logoProg'); 

                this.add.text(10, 10, 'Jogando como:', { fontFamily: "'Courier New', Courier, monospace", fontSize: 18, color: "#333333", fontWeight: 'bold' });
                this.add.text(10, 30, this.name + '!', { fontFamily: "'Courier New', Courier, monospace", fontSize: 25, color: "#333333" });
                this.add.text(8, 54, '[Trocar]', { fontFamily: "'Courier New', Courier, monospace", fontSize: 15, color: "#333333" })
                .setInteractive()
                .on('pointerover', function () {
                    this.setStyle({fill: '#FFFF00'});
                })
                .on('pointerout', function () {
                    this.setStyle({fill: '#333333'});
                })
                .on('pointerdown', function () {
                    this.scene.restart();
                    this.scene.start('login');
                }, this);

                this.lifesBox = this.add.image(410, 35, 'lifes3');

                this.add.text(630, 10, 'Tempo restante:', { fontFamily: "'Courier New', Courier, monospace", fontSize: 18, color: "#333333", fontWeight: 'bold' });
                
                this.countdownText = this.add.text(715, 30, this.formatTime(this.initialCountdownTime), { fontFamily: "'Courier New', Courier, monospace", fontSize: 25, color: "#333333" });
                this.timedEvent = this.time.addEvent({ delay: 1000, callback: this.onEvent, callbackScope: this, loop: true });

                this.questionsJson = this.cache.json.get('questionsJson').sort(() => Math.random() - 0.5);
                this.questionsJson.forEach((question) => {
                    this.questionsIds.push(question.id);
                });
                this.currentQuestion = this.questionsIds[0];               
                this.showQuestion();

                if(document.querySelector('#questionHTML')) {
                    this.input.keyboard.on('keydown-ONE', (event) => {
                        this.checkQuestion(this.currentQuestion, 'answer_a', 1);
                    });
                    this.input.keyboard.on('keydown-TWO', (event) => {
                        this.checkQuestion(this.currentQuestion, 'answer_b', 2);
                    });
                    this.input.keyboard.on('keydown-THREE', (event) => {
                        this.checkQuestion(this.currentQuestion, 'answer_c', 3);        
                    });
                    this.input.keyboard.on('keydown-FOUR', (event) => {
                        this.checkQuestion(this.currentQuestion, 'answer_d', 4);
                    });
                }
            },

            showQuestion: function(questionID) {
                var questionID = questionID || this.currentQuestion;
                this.questionHTML = this.add.dom(400, 200).setInteractive().createFromCache(`question-${questionID}`);
                document.querySelector("#questionInfo").innerHTML = `Questão ${this.getQuestionIndexByID(this.questionsJson, questionID)+1} de ${this.questionsJson.length} // Acertos: ${this.questionsCorrects}`;            
            },

            checkQuestion: function(questionID, answerID, keyNumber) {
                if(this.checkAnswerKeyExists(questionID, answerID, keyNumber) && !this.gameEnd) {
                    this.questionHTML.destroy();
                    
                    if(!this.checkCorrectQuestion(questionID, answerID)) {
                        if(this.lifes === 0) {
                            return this.gameOver('[Acabou suas vidas]');
                        } else {
                            this.updateLifes();
                        }
                    }

                    if(this.questionsJson.length === (this.getQuestionIndexByID(this.questionsJson, questionID)+1)) {
                        this.success();
                    } else {
                        var nextQuestion = this.getNextQuestionID(this.questionsJson, questionID);
                        this.currentQuestion = nextQuestion;
                        this.showQuestion(nextQuestion);
                    }
                }
            },

            checkAnswerKeyExists: function(questionID, answerID, keyNumber) {
                var totalAnswers = this.getQuestionByID(this.questionsJson, questionID).answers;
                totalAnswers = Object.values(totalAnswers).filter(Boolean).length;
                return (keyNumber <= totalAnswers);
            },

            checkCorrectQuestion: function(questionID, answerID) {
                var question = this.getQuestionByID(this.questionsJson, questionID);               
                var correct = false;

                switch(answerID) {
                    case 'answer_a':
                        correct = (question.correct_answers.answer_a_correct === "true");
                        break;
                    case 'answer_b':
                        correct = (question.correct_answers.answer_b_correct === "true");
                        break;
                    case 'answer_c':
                        correct = (question.correct_answers.answer_c_correct === "true");
                        break;
                    case 'answer_d':
                        correct = (question.correct_answers.answer_d_correct === "true");
                        break;
                }

                if(correct) {
                    this.questionsCorrects += 1;
                }

                this.tweenProg(correct);

                return correct;
            },

            updateLifes: function() {
                this.lifes -= 1;
                this.lifesBox.destroy();
                this.lifesBox = this.add.image(410, 35, `lifes${this.lifes}`);
            },
            
            loadQuestionsHTML: function() {
                var questionsIds = [792,983,419,651,593,606,901,243,850,845,1066,829,842,1058,471,689,453,629,801,295];
                questionsIds.forEach((id) => {
                    var file = this.load.html(`question-${id}`, `html/question-${id}.html`);
                    file.start();
                });
            },

            isDay: function() {
                const hours = (new Date()).getHours();
                return (hours >= 6 && hours < 18);
            },

            gameOver: function(text) {
                this.timedEvent.remove(false);
                this.input.keyboard.enabled = false;
                this.gameEnd = true;
                var overHTML = this.add.dom(400, 200).setInteractive().createFromCache('gameOver');
                document.querySelector("#overText").innerHTML = text || '';
                document.querySelector("#finalScore").innerHTML = `Acertou ${this.questionsCorrects} de ${this.questionsJson.length} questões!`;
                document.querySelector("#playAgain").addEventListener('click', () => {
                    this.scene.restart();
                });
            },

            success: function() {
                this.input.keyboard.enabled = false;
                this.gameEnd = true;

                var overHTML = this.add.dom(400, 200).setInteractive().createFromCache('success');
                document.querySelector("#playAgain").addEventListener('click', () => {
                    this.scene.restart();
                });

                this.prog.destroy();
                this.prog = this.physics.add.image(760, 380, 'logoProg');
                this.prog.setVelocity(200, 200);
                this.prog.setBounce(1, 1);
                this.prog.setCollideWorldBounds(true);

                var emitter = this.greenParticle.createEmitter({
                    speed: 100,
                    scale: { start: 0.5, end: 0 },
                    blendMode: 'ADD'
                });
                emitter.startFollow(this.prog);

                console.log('VENCEU!');
            },

            onEvent: function() {
                if (this.initialCountdownTime === 0) {
                    this.timedEvent.remove(false);
                    this.questionHTML.destroy();
                    this.gameOver('[Acabou seu tempo]');
                } else {
                    this.initialCountdownTime -= 1;
                    this.countdownText.setText(this.formatTime(this.initialCountdownTime));
                }
            },

            tweenProg: function(correct) {
                this.input.keyboard.enabled = false;
                
                if(correct){ 
                    var emitter = this.greenParticle.createEmitter({
                        speed: 100,
                        scale: { start: 0.4, end: 0 },
                        blendMode: 'ADD',
                        lifespan: 800,
                    });
                    emitter.startFollow(this.prog);
                }

                const tween = this.add.tween({
                    targets: this.prog,
                    x: this.prog.x+36.5,
                    duration: 1000,
                    yoyo: false,
                    ease: 'Linear',
                    repeat: 0,
                    onComplete: () => {
                        this.input.keyboard.enabled = true;
                        emitter && emitter.stop();
                    }
                });
            },

            formatTime(seconds){
                var minutes = Math.floor(seconds/60).toString().padStart(2,'0');;
                var partInSeconds = seconds%60;
                partInSeconds = partInSeconds.toString().padStart(2,'0');
                return `${minutes}:${partInSeconds}`;
            },

            getQuestionByID: function(myArray, value) {
                return myArray.find(item => item.id === value);
            },

            getQuestionIndexByID: function(myArray, value) {
                return myArray.findIndex(item => item.id === value);
            },

            getNextQuestionID: function(myArray, value) {
                var currentIndex = this.getQuestionIndexByID(myArray, value);
                return this.questionsJson[currentIndex+1].id;
            }
    
        });
       
        var config = {
            type: Phaser.WEBGL,
            parent: 'game',
            width: 800,
            height: 429,
            backgroundColor: '#000000',
            autoCenter: true,
            dom: {
                createContainer: true
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            },
            scene: [Login, Info, Game]
            //scene: [Game]
        };
        
        var game = new Phaser.Game(config);

    </script>
    <div id="game"></div>
    <div id="container">
        <h1>Referências:</h1>
        <ul>
            <li>Phaser (Game Framework) - <a href="https://phaser.io/" target="_blank">https://phaser.io/</a></li>
            <li>JavaScript (Linguagem de Programação) - <a href="https://www.javascript.com/" target="_blank">https://www.javascript.com/</a></li>
            <li>QuizAPI (API de Questões) - <a href="https://quizapi.io/" target="_blank">https://quizapi.io/</a></li>
            <li>ShutterStock (Imagens) - <a href="https://www.shutterstock.com/pt/" target="_blank">https://www.shutterstock.com/pt/</a></li>
            <li>PixaBay (Efeitos Sonoros) - <a href="https://pixabay.com/pt/sound-effects/" target="_blank">https://pixabay.com/pt/sound-effects/</a></li>
            <li>ChatGPT (Textos e traduções) - <a href="https://chat.openai.com/" target="_blank">https://chat.openai.com/</a></li>
            <li>StackOverflow (Dúvidas gerais) - <a href="https://stackoverflow.com/" target="_blank">https://stackoverflow.com/</a></li>
        </ul>
    </div>
</body>
</html>