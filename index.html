<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser-arcade-physics.js"></script>
    <title>Quiz Tech</title>
    <style>
        body {
            margin: 0;
            background-color: #363a3c;
        }
    </style>
</head>
<body>

    <script>
        var Login = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Login ()
            {
                Phaser.Scene.call(this, { key: 'login'});
            },
        
            preload: function ()
            {
                this.load.html('formName', 'html/form-name.html');
                this.load.image('logo', 'images/logo2.png');
                this.load.image('bgLogin', 'images/bg-login2.jpg');
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bgLogin');
                this.add.image(400, 130, 'logo');
                
                var element = this.add.dom(400, 300).setInteractive().createFromCache('formName');

                element.addListener('click');
                element.on('click', function(event) {
                    if (event.target.name === 'showInfo')
                    {
                        var inputText = this.getChildByName('name');
            
                        if (inputText.value !== '')
                        {
                            this.removeListener('click');
                            this.setVisible(false);
                            var name = inputText.value;
                            this.scene.scene.start('info', { name: name.substring(0, 15) });    
                        }
                    }
                });
            }
        });
        
        var Info = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Info ()
            {
                Phaser.Scene.call(this, { key: 'info'});
            },
        
            init: function (data)
            {
                this.name = data.name;
            },

            preload: function ()
            {
                this.load.image('bgInfo', 'images/bg-info.jpg');
                this.load.html('infoText', 'html/info.html');
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bgInfo');
                this.add.text(20, 20, 'Bem-vindo,', { fontFamily: "'Courier New', Courier, monospace", fontSize: 20, color: "#333333", fontWeight: 'bold' });
                this.add.text(20, 40, this.name + '!', { fontFamily: "'Courier New', Courier, monospace", fontSize: 30, color: "#333333" });

                var element = this.add.dom(400, 250).setInteractive().createFromCache('infoText');
                element.addListener('click');
                element.on('click', function(event) {
                    if (event.target.name === 'startGame')
                    {                  
                        this.scene.scene.start('game', { name: this.scene.name.substring(0, 15) });
                    }
                });
            }
        
        });

        var Game = new Phaser.Class({

            Extends: Phaser.Scene,
        
            initialize:
        
            function Game ()
            {
                Phaser.Scene.call(this, { key: 'game'});
            },
        
            init: function (data)
            {
                this.name = data.name;
                this.initialCountdownTime = 10; //segundos
                // this.name = "Hugo JÃºnior";
            },

            preload: function ()
            {      
                this.load.image('logoProg', 'images/prog2.png');
                this.load.image('red', 'images/blue.png');

                // life images
                this.load.image('lifes3', 'images/lifes3.png');
                this.load.image('lifes2', 'images/lifes2.png');
                this.load.image('lifes1', 'images/lifes1.png');
                this.load.image('lifes0', 'images/lifes0.png');

                if(this.isDay()) {
                    this.load.image('bg', 'images/bg-dia-800.jpg');
                } else {
                    this.load.image('bg', 'images/bg-noite-800.jpg');
                }
            },
        
            create: function ()
            {
                this.add.image(400, 214, 'bg');

                var prog = this.add.image(45, 380, 'logoProg');
                const tween = this.add.tween({
                    targets: prog,
                    x: 748,
                    duration: 4000,
                    yoyo: true,
                    ease: 'Linear',
                    repeat: -1
                });

                this.add.text(20, 20, 'Jogando como:', { fontFamily: "'Courier New', Courier, monospace", fontSize: 18, color: "#333333", fontWeight: 'bold' });
                this.add.text(20, 40, this.name + '!', { fontFamily: "'Courier New', Courier, monospace", fontSize: 25, color: "#333333" });

                this.lifes = this.add.image(410, 35, 'lifes3');

                this.input.keyboard.on('keydown-ZERO', (event) => {
                    this.lifes.visible = false;
                    this.lifes = this.add.image(410, 35, 'lifes0');
                });
                this.input.keyboard.on('keydown-ONE', (event) => {
                    this.lifes.visible = false;
                    this.lifes = this.add.image(410, 35, 'lifes1');
                });
                this.input.keyboard.on('keydown-TWO', (event) => {
                    this.lifes.visible = false;
                    this.lifes = this.add.image(410, 35, 'lifes2');
                });
                this.input.keyboard.on('keydown-THREE', (event) => {
                    this.lifes.visible = false;
                    this.lifes = this.add.image(410, 35, 'lifes3');
                });
                
                this.add.text(630, 20, 'Tempo restante:', { fontFamily: "'Courier New', Courier, monospace", fontSize: 18, color: "#333333", fontWeight: 'bold' });
                
                this.countdownText = this.add.text(715, 40, this.formatTime(this.initialCountdownTime), { fontFamily: "'Courier New', Courier, monospace", fontSize: 25, color: "#333333" });
                this.timedEvent = this.time.addEvent({ delay: 1000, callback: this.onEvent, callbackScope: this, loop: true });

            },

            isDay() {
                const hours = (new Date()).getHours();
                return (hours >= 6 && hours < 18);
            },

            onEvent: function ()
            {
                if (this.initialCountdownTime === 0) {
                    this.timedEvent.remove(false);
                    console.log('Game Over por tempo!');
                } else {
                    this.initialCountdownTime -= 1;
                    this.countdownText.setText(this.formatTime(this.initialCountdownTime));
                }
            },

            formatTime(seconds){
                var minutes = Math.floor(seconds/60).toString().padStart(2,'0');;
                var partInSeconds = seconds%60;
                partInSeconds = partInSeconds.toString().padStart(2,'0');
                return `${minutes}:${partInSeconds}`;
            }
    
        });
       
        var config = {
            type: Phaser.WEBGL,
            parent: 'game',
            width: 800,
            height: 429,
            backgroundColor: '#000000',
            autoCenter: true,
            dom: {
                createContainer: true
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            },
            // scene: [Game]
            scene: [Login, Info, Game]
        };
        
        var game = new Phaser.Game(config);

    </script>

</body>
</html>